# BakaRay 测试环境 - 面板 + 两个节点（入口 + 出口）
# 启动: docker-compose -f docker-compose.yml -f docker-compose.test.yml up -d --build
# 停止: docker-compose -f docker-compose.yml -f docker-compose.test.yml down -v

services:
  # BakaRay 管理面板
  bakaray-panel:
    build:
      context: ..
      dockerfile: BakaRay/Dockerfile.panel
    container_name: bakaray-panel
    ports:
      - "8500:80"
    environment:
      - DB_TYPE=sqlite
      - DB_PATH=/app/data/bakaray.db
      - REDIS_HOST=bakaray-redis
      - REDIS_PORT=6379
      - REDIS_PASSWORD=bakaray-redis-password
      - SERVER_HOST=0.0.0.0
      - SERVER_PORT=8080
      - SERVER_MODE=debug
      - JWT_SECRET=test-jwt-secret-change-in-production
      - NODE_SECRET=test-node-secret-change-in-production
      - NODE_REPORT_INTERVAL=10
      - INIT_USERNAME=admin
      - INIT_PASSWORD=admin123
      - INIT_ROLE=admin
      - INIT_GROUP=0
    volumes:
      - bakaray_data:/app/data
      - bakaray_logs:/app/logs
    depends_on:
      bakaray-redis:
        condition: service_healthy
    networks:
      bakaray_net:
        ipv4_address: 172.28.0.10
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost/health"]
      interval: 10s
      timeout: 3s
      retries: 3

  # Redis 缓存
  bakaray-redis:
    image: redis:7-alpine
    container_name: bakaray-redis
    command: redis-server --appendonly yes --requirepass bakaray-redis-password
    ports:
      - "6380:6379"
    volumes:
      - bakaray_redis_data:/data
    networks:
      bakaray_net:
        ipv4_address: 172.28.0.12
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "bakaray-redis-password", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # 节点 1 - 入口节点 (Entry Node)
  bakaray-node-entry:
    build:
      context: ../BakaRay-Node
      dockerfile: Dockerfile.node
    container_name: bakaray-node-entry
    ports:
      - "8601:8081"  # 管理端口
      - "8600:8080"  # 转发端口
    environment:
      - PANEL_URL=http://bakaray-panel:8080
      - NODE_ID=1
      - NODE_SECRET=entry-node-secret-key
      - REPORT_INTERVAL=10
      - PROBE_INTERVAL=5
      - NODE_HTTP_PORT=8081
      - LOG_LEVEL=debug
    cap_add:
      - NET_ADMIN
    volumes:
      - bakaray_node_entry_data:/app/data
    depends_on:
      bakaray-panel:
        condition: service_healthy
    networks:
      bakaray_net:
        ipv4_address: 172.28.0.20
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8081/health"]
      interval: 10s
      timeout: 3s
      retries: 3

  # 节点 2 - 出口节点 (Exit Node)
  bakaray-node-exit:
    build:
      context: ../BakaRay-Node
      dockerfile: Dockerfile.node
    container_name: bakaray-node-exit
    ports:
      - "8611:8081"  # 管理端口
      - "8610:8080"  # 转发端口
    environment:
      - PANEL_URL=http://bakaray-panel:8080
      - NODE_ID=2
      - NODE_SECRET=exit-node-secret-key
      - REPORT_INTERVAL=10
      - PROBE_INTERVAL=5
      - NODE_HTTP_PORT=8081
      - LOG_LEVEL=debug
    cap_add:
      - NET_ADMIN
    volumes:
      - bakaray_node_exit_data:/app/data
    depends_on:
      bakaray-panel:
        condition: service_healthy
    networks:
      bakaray_net:
        ipv4_address: 172.28.0.21
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8081/health"]
      interval: 10s
      timeout: 3s
      retries: 3

networks:
  bakaray_net:
    name: bakaray_net
    driver: bridge
    ipam:
      config:
        - subnet: 172.28.0.0/16

volumes:
  bakaray_data:
  bakaray_redis_data:
  bakaray_logs:
  bakaray_node_entry_data:
  bakaray_node_exit_data:
